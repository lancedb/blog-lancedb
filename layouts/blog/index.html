{{ define "main" }}
<div class="container">
{{ $allPosts := where .Site.RegularPages "Section" "blog" }}
{{ $featuredPosts := where $allPosts ".Params.featured" true }}

<!-- Build non-featured posts collection -->
{{ $nonFeaturedPosts := slice }}
{{ range $allPosts }}
    {{ if not .Params.featured }}
        {{ $nonFeaturedPosts = $nonFeaturedPosts | append . }}
    {{ end }}
{{ end }}

<!-- Create paginator -->
{{ $paginator := .Paginate $nonFeaturedPosts }}

<!-- Featured Section - Only show on first page -->
{{ if and $featuredPosts (eq $paginator.PageNumber 1) }}
    {{ $mainFeatured := index $featuredPosts 0 }}
    {{ $sideFeatured := after 1 $featuredPosts }}
    <div class="featured-section">
        <!-- Main Featured Post -->
        <article class="main-featured">
            <a href="{{ $mainFeatured.RelPermalink }}">
                <img src="{{ $mainFeatured.Params.image | default "/assets/blog/preview.png" }}" alt="{{ $mainFeatured.Title }}" class="preview-image">
            </a>
            <h2><a href="{{ $mainFeatured.RelPermalink }}">{{ $mainFeatured.Title }}</a></h2>
            <div class="post-meta">
                {{- range $index, $category := $mainFeatured.Params.categories -}}
                    {{- if $index }} / {{ end -}}
                    {{- $category -}}
                {{- end -}}
                {{- if $mainFeatured.Params.categories }} / {{ end -}}
                {{- if $mainFeatured.Params.author2 -}}
                    {{- $mainFeatured.Params.author }} & {{ $mainFeatured.Params.author2 -}}
                {{- else -}}
                    {{- $mainFeatured.Params.author -}}
                {{- end -}} / {{ $mainFeatured.Date.Format "January 2, 2006" -}}
            </div>
            <p class="post-description">{{ $mainFeatured.Description | default (truncate 160 $mainFeatured.Summary) }}</p>
        </article>
        <!-- Side Featured Posts -->
        <div class="side-featured">
            {{ range first 2 $sideFeatured }}
                <article class="side-featured-post">
                    <a href="{{ .RelPermalink }}">
                        <img src="{{ .Params.image | default "/assets/blog/preview.png" }}" alt="{{ .Title }}" class="preview-image">
                    </a>
                    <h2><a href="{{ .RelPermalink }}">{{ .Title }}</a></h2>
                    <div class="post-meta">
                        {{- range $index, $category := .Params.categories -}}
                            {{- if $index }} / {{ end -}}
                            {{- $category -}}
                        {{- end -}}
                        {{- if .Params.categories }} / {{ end -}}
                        {{- if .Params.author2 -}}
                            {{- .Params.author }} & {{ .Params.author2 -}}
                        {{- else -}}
                            {{- .Params.author -}}
                        {{ end }} / {{ .Date.Format "January 2, 2006" -}}
                    </div>
                </article>
            {{ end }}
        </div>
    </div>
{{ end }}

<!-- Pagination and Subscribe Section -->
<div class="pagination-subscribe-container">
    <!-- Left side - Pagination -->
    <div class="pagination-section">
        <nav class="pagination">
            <div class="pagination-links">
                {{ if $paginator.HasPrev }}
                    <a href="{{ $paginator.Prev.URL }}" class="pagination-link prev" rel="prev">
                        <span class="pagination-arrow">‚Üê</span>
                        <span class="pagination-text">Previous</span>
                    </a>
                {{ end }}
                
                <!-- All page numbers -->
                {{ range $paginator.Pagers }}
                    {{ if eq .PageNumber $paginator.PageNumber }}
                        <span class="pagination-link current">{{ .PageNumber }}</span>
                    {{ else }}
                        <a href="{{ .URL }}" class="pagination-link page-number">{{ .PageNumber }}</a>
                    {{ end }}
                {{ end }}
                
                {{ if $paginator.HasNext }}
                    <a href="{{ $paginator.Next.URL }}" class="pagination-link next" rel="next">
                        <span class="pagination-text">Next</span>
                        <span class="pagination-arrow">‚Üí</span>
                    </a>
                {{ end }}
            </div>
        </nav>
    </div>
    
    <!-- Right side - Subscribe -->
    <div class="subscribe-section">
        <button class="subscribe-cta-button" onclick="openSubscribeModal()">
            <span class="subscribe-icon">üìß</span>
            <span class="subscribe-text">Subscribe to Newsletter</span>
        </button>
    </div>
</div>

<!-- Posts Grid -->
<div class="post-grid">
    {{ range $paginator.Pages }}
        <article class="post-card">
            <a href="{{ .RelPermalink }}">
                <img src="{{ .Params.image | default "/assets/blog/preview.png" }}" alt="{{ .Title }}" class="preview-image">
            </a>
            <h2><a href="{{ .RelPermalink }}">{{ .Title }}</a></h2>
            <div class="post-meta">
                {{- range $index, $category := .Params.categories -}}
                    {{- if $index }} / {{ end -}}
                    {{- $category -}}
                {{- end -}}
                {{- if .Params.categories }} / {{ end -}}
                {{- if .Params.author2 -}}
                    {{- .Params.author }} & {{ .Params.author2 -}}
                {{- else -}}
                    {{- .Params.author -}}
                {{ end }} / {{ .Date.Format "January 2, 2006" -}}
            </div>
            <p class="post-description">{{ .Description | default (truncate 100 .Summary) }}</p>
        </article>
    {{ end }}
</div>

<!-- Pagination Navigation (Bottom) -->
{{ if gt $paginator.TotalPages 1 }}
<nav class="pagination">
    <div class="pagination-links">
        {{ if $paginator.HasPrev }}
            <a href="{{ $paginator.Prev.URL }}" class="pagination-link prev" rel="prev">
                <span class="pagination-arrow">‚Üê</span>
                <span class="pagination-text">Previous</span>
            </a>
        {{ end }}
        
        <!-- All page numbers -->
        {{ range $paginator.Pagers }}
            {{ if eq .PageNumber $paginator.PageNumber }}
                <span class="pagination-link current">{{ .PageNumber }}</span>
            {{ else }}
                <a href="{{ .URL }}" class="pagination-link page-number">{{ .PageNumber }}</a>
            {{ end }}
        {{ end }}
        
        {{ if $paginator.HasNext }}
            <a href="{{ $paginator.Next.URL }}" class="pagination-link next" rel="next">
                <span class="pagination-text">Next</span>
                <span class="pagination-arrow">‚Üí</span>
            </a>
        {{ end }}
    </div>
</nav>
{{ end }}
</div>

<!-- Subscribe Modal -->
<div id="subscribeModal" class="subscribe-modal">
    <div class="subscribe-modal-content">
        <div class="subscribe-modal-header">
            <h3>Subscribe to Our Newsletter</h3>
            <button class="subscribe-modal-close" onclick="closeSubscribeModal()">&times;</button>
        </div>
        <form class="subscribe-form" id="subscribeForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" name="firstName" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
            </div>
            <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="marketing" name="marketing">
                    <span class="checkmark"></span>
                    I agree to receive marketing communications from LanceDB
                </label>
            </div>
            <button type="submit" class="subscribe-submit-btn">
                <span class="btn-text">Subscribe Now</span>
                <span class="btn-loading" style="display: none;">Subscribing...</span>
            </button>
        </form>
    </div>
</div>

<!-- Include subscribe JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    // Subscribe modal functionality
    const modal = document.getElementById('subscribeModal');
    const form = document.getElementById('subscribeForm');
    
    // Open modal function
    window.openSubscribeModal = function() {
        if (modal) {
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
            // Focus on first input
            const firstInput = modal.querySelector('input');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
        }
    };
    
    // Close modal function
    window.closeSubscribeModal = function() {
        if (modal) {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
            // Reset form
            if (form) {
                form.reset();
            }
        }
    };
    
    // Close modal when clicking outside
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeSubscribeModal();
            }
        });
    }
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
            closeSubscribeModal();
        }
    });
    
    // Handle form submission
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = form.querySelector('.subscribe-submit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            // Show loading state
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            submitBtn.disabled = true;
            
            // Get form data
            const formData = new FormData(form);
            const data = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                marketing: formData.get('marketing') === 'on'
            };
            
            // Simulate API call (replace with actual endpoint)
            setTimeout(() => {
                // Success - you can replace this with actual API call
                console.log('Subscription data:', data);
                
                // Show success message
                showSuccessMessage();
                
                // Reset form and close modal after delay
                setTimeout(() => {
                    closeSubscribeModal();
                    // Reset button state
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                    submitBtn.disabled = false;
                }, 2000);
                
            }, 1500);
        });
    }
    
    // Show success message
    function showSuccessMessage() {
        const modalContent = modal.querySelector('.subscribe-modal-content');
        const originalContent = modalContent.innerHTML;
        
        modalContent.innerHTML = `
            <div class="subscribe-success">
                <div class="success-icon">‚úÖ</div>
                <h3>Thank You!</h3>
                <p>You've been successfully subscribed to our newsletter.</p>
                <p>We'll keep you updated with the latest insights and updates from LanceDB.</p>
            </div>
        `;
    }
});
</script>

{{ end }}

